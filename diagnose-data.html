<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnosa Data</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 p-8">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-2xl shadow-lg p-8">
            <h1 class="text-3xl font-bold text-slate-800 mb-6">üîç Diagnosa Data localStorage</h1>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <button onclick="diagnose()" 
                    class="w-full p-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-colors text-sm">
                    üîç Diagnosa Struktur Data
                </button>
                <button onclick="renderHafalanOverview()" 
                    class="w-full p-3 bg-emerald-600 text-white rounded-xl font-bold hover:bg-emerald-700 transition-colors text-sm">
                    üìñ Tampilkan Diagnosa Hafalan
                </button>
                <button onclick="clearOutput()" 
                    class="w-full p-3 bg-slate-500 text-white rounded-xl font-bold hover:bg-slate-600 transition-colors text-sm">
                    üßπ Bersihkan Tampilan
                </button>
            </div>

            <div id="output" class="space-y-4"></div>
        </div>
    </div>
    
    <script>
        function addOutput(title, content, type = 'info') {
            const output = document.getElementById('output');
            
            let bgColor = 'bg-slate-50';
            let borderColor = 'border-slate-200';
            let textColor = 'text-slate-700';
            
            if (type === 'success') {
                bgColor = 'bg-green-50';
                borderColor = 'border-green-200';
                textColor = 'text-green-700';
            } else if (type === 'error') {
                bgColor = 'bg-red-50';
                borderColor = 'border-red-200';
                textColor = 'text-red-700';
            } else if (type === 'warning') {
                bgColor = 'bg-amber-50';
                borderColor = 'border-amber-200';
                textColor = 'text-amber-700';
            }
            
            const div = document.createElement('div');
            div.className = `${bgColor} border ${borderColor} rounded-xl p-4`;
            div.innerHTML = `
                <h3 class="font-bold ${textColor} mb-2">${title}</h3>
                <pre class="text-sm ${textColor} whitespace-pre-wrap font-mono">${content}</pre>
            `;
            output.appendChild(div);
        }
        
        function clearOutput() {
            const output = document.getElementById('output');
            if (output) {
                output.innerHTML = '';
            }
        }

        function getParsedData() {
            const raw = localStorage.getItem('halaqahData');
            if (!raw) return null;
            try {
                return JSON.parse(raw);
            } catch (e) {
                return null;
            }
        }

        function diagnose() {
            clearOutput();
            
            try {
                addOutput('üì¶ localStorage Keys', 
                    Object.keys(localStorage).join('\n') || 'Kosong', 
                    'info');
                
                const data = localStorage.getItem('halaqahData');
                if (!data) {
                    addOutput('‚ùå halaqahData', 'Tidak ditemukan di localStorage', 'error');
                    return;
                }
                
                addOutput('‚úÖ halaqahData', 'Ditemukan', 'success');
                
                let parsed;
                try {
                    parsed = JSON.parse(data);
                    addOutput('‚úÖ JSON Parse', 'Berhasil parse JSON', 'success');
                } catch (e) {
                    addOutput('‚ùå JSON Parse Error', e.message, 'error');
                    return;
                }
                
                addOutput('üìä Struktur Data', 
                    `Keys: ${Object.keys(parsed).join(', ')}`, 
                    'info');
                
                if (parsed.students) {
                    addOutput('üë• Students', 
                        `Total: ${parsed.students.length}\nType: ${Array.isArray(parsed.students) ? 'Array' : typeof parsed.students}`, 
                        parsed.students.length > 0 ? 'success' : 'warning');
                    
                    if (parsed.students.length > 0) {
                        const sample = parsed.students[0];
                        addOutput('üë§ Sample Student', 
                            JSON.stringify(sample, null, 2), 
                            'info');
                        
                        const totalPoints = parsed.students.reduce((sum, s) => sum + (s.total_points || 0), 0);
                        const negativePoints = parsed.students.filter(s => s.total_points < 0);
                        
                        addOutput('üìà Statistik Poin', 
                            `Total Poin: ${totalPoints}\nSantri dengan poin negatif: ${negativePoints.length}\n\nDetail poin negatif:\n${negativePoints.map(s => `- ${s.name}: ${s.total_points} poin`).join('\n')}`, 
                            negativePoints.length > 0 ? 'warning' : 'success');
                    }
                } else {
                    addOutput('‚ùå Students', 'Tidak ditemukan atau null', 'error');
                }
                
                if (parsed.halaqahs) {
                    addOutput('üèõÔ∏è Halaqahs', 
                        `Total: ${parsed.halaqahs.length}\nType: ${Array.isArray(parsed.halaqahs) ? 'Array' : typeof parsed.halaqahs}`, 
                        'info');
                } else {
                    addOutput('‚ö†Ô∏è Halaqahs', 'Tidak ditemukan', 'warning');
                }
                
                if (parsed.stats) {
                    addOutput('üìä Stats', 
                        JSON.stringify(parsed.stats, null, 2), 
                        'info');
                } else {
                    addOutput('‚ö†Ô∏è Stats', 'Tidak ditemukan', 'warning');
                }
                
                const sizeKB = (data.length / 1024).toFixed(2);
                addOutput('üíæ Ukuran Data', 
                    `${sizeKB} KB (${data.length} characters)`, 
                    'info');
                
                let recommendations = [];
                if (parsed.students && parsed.students.length === 0) {
                    recommendations.push('‚ö†Ô∏è Data students kosong - mungkin perlu reload dari Supabase');
                }
                if (parsed.students && parsed.students.some(s => s.total_points < 0)) {
                    recommendations.push('‚ö†Ô∏è Ada poin negatif - gunakan script reset poin');
                }
                if (!parsed.students) {
                    recommendations.push('‚ùå Struktur data corrupt - gunakan script hapus semua data');
                }
                
                if (recommendations.length > 0) {
                    addOutput('üí° Rekomendasi', 
                        recommendations.join('\n\n'), 
                        'warning');
                } else {
                    addOutput('‚úÖ Status', 
                        'Data terlihat normal!', 
                        'success');
                }
                
            } catch (error) {
                addOutput('‚ùå Error', error.message + '\n\n' + error.stack, 'error');
            }
        }

        function renderHafalanOverview() {
            clearOutput();
            
            const parsed = getParsedData();
            if (!parsed) {
                addOutput('‚ùå halaqahData', 'Tidak ditemukan atau gagal parse JSON', 'error');
                return;
            }
            
            const students = Array.isArray(parsed.students) ? parsed.students.slice() : [];
            if (students.length === 0) {
                addOutput('üë• Hafalan', 'Tidak ada data students', 'warning');
                return;
            }

            const lembagaGroups = {};
            students.forEach(s => {
                const lembaga = s.lembaga || 'MTA';
                if (!lembagaGroups[lembaga]) lembagaGroups[lembaga] = [];
                lembagaGroups[lembaga].push(s);
            });

            const lembagaNames = Object.keys(lembagaGroups).sort();
            const lines = [];

            lembagaNames.forEach(lembaga => {
                const list = lembagaGroups[lembaga];
                const totalStudents = list.length;
                const withHafalan = list.filter(s => Number(s.total_hafalan) > 0);
                const zeroHafalan = list.filter(s => !s.total_hafalan || Number(s.total_hafalan) <= 0);
                const avgHafalan = list.reduce((sum, s) => sum + (Number(s.total_hafalan) || 0), 0) / (list.length || 1);

                lines.push(`=== ${lembaga} ===`);
                lines.push(`Total santri: ${totalStudents}`);
                lines.push(`Santri dengan hafalan > 0: ${withHafalan.length}`);
                lines.push(`Santri hafalan 0: ${zeroHafalan.length}`);
                lines.push(`Rata-rata hafalan: ${avgHafalan.toFixed(2)} Juz`);
                lines.push('');

                const top5 = withHafalan
                    .slice()
                    .sort((a, b) => (Number(b.total_hafalan) || 0) - (Number(a.total_hafalan) || 0))
                    .slice(0, 5);

                if (top5.length > 0) {
                    lines.push('Top 5 hafalan tertinggi:');
                    top5.forEach((s, idx) => {
                        lines.push(`${idx + 1}. ${s.name} (${s.halaqah || '-'}) - ${Number(s.total_hafalan).toFixed(2)} Juz`);
                    });
                    lines.push('');
                }

                const zeroSamples = zeroHafalan.slice(0, 5);
                if (zeroSamples.length > 0) {
                    lines.push('Contoh santri hafalan 0:');
                    zeroSamples.forEach((s, idx) => {
                        lines.push(`${idx + 1}. ${s.name} (${s.halaqah || '-'})`);
                    });
                    lines.push('');
                }

                lines.push('------------------------------');
                lines.push('');
            });

            addOutput('üìñ Diagnosa Hafalan per Lembaga', lines.join('\n'), 'info');
        }
        
        window.addEventListener('load', () => {
            setTimeout(diagnose, 500);
        });
    </script>
</body>
</html>
