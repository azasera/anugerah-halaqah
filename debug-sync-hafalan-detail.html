<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Sync Hafalan Detail</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            font-weight: bold;
        }
        button:hover { background: #45a049; }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 12px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background: #4CAF50;
            color: white;
            position: sticky;
            top: 0;
        }
        tr:nth-child(even) { background: #f9f9f9; }
        .match { background: #d4edda !important; }
        .mismatch { background: #fff3cd !important; }
        .not-found { background: #f8d7da !important; }
        .zero { background: #e2e3e5 !important; }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Sync Hafalan Detail</h1>
        <p>Tool untuk debug matching nama dan total hafalan</p>

        <div class="section">
            <h3>Pilih Jenjang</h3>
            <select id="jenjang" style="padding: 8px; font-size: 14px;">
                <option value="sd">SD</option>
                <option value="smp">SMP</option>
                <option value="sma">SMA</option>
                <option value="mta" selected>MTA</option>
            </select>
            <button onclick="analyzeSync()">Analisis Sync</button>
        </div>

        <div class="section">
            <h3>Hasil Analisis</h3>
            <div id="summary"></div>
        </div>

        <div class="section">
            <h3>Detail Matching</h3>
            <div id="details"></div>
        </div>
    </div>

    <script>
        const normalizeName = (name) => {
            if (!name) return '';
            return String(name).toLowerCase().replace(/[\s\u00A0]+/g, ' ').trim();
        };

        const levenshteinDistance = (str1, str2) => {
            const matrix = [];
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            return matrix[str2.length][str1.length];
        };

        const calculateSimilarity = (str1, str2) => {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            if (longer.length === 0) return 100;
            const editDistance = levenshteinDistance(longer, shorter);
            return ((longer.length - editDistance) / longer.length) * 100;
        };

        async function analyzeSync() {
            const jenjang = document.getElementById('jenjang').value;
            const summary = document.getElementById('summary');
            const details = document.getElementById('details');
            
            summary.innerHTML = 'Loading...';
            details.innerHTML = '';

            try {
                // Fetch API data
                const url = `https://asia-southeast1-mootabaah.cloudfunctions.net/api/totalHafalan2025/${jenjang}`;
                const res = await fetch(url);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                
                const json = await res.json();
                const allGuruData = json?.data || {};

                // Get local data
                const saved = localStorage.getItem('halaqahData');
                if (!saved) {
                    summary.innerHTML = '<span style="color: red;">‚ùå Tidak ada data di localStorage</span>';
                    return;
                }

                const dashboardData = JSON.parse(saved);
                const lembagaMap = {
                    'sd': 'SDITA',
                    'smp': 'SMPITA',
                    'sma': 'SMAITA',
                    'mta': 'MTA'
                };
                const lembagaKey = lembagaMap[jenjang];
                const students = dashboardData.students.filter(s => s.lembaga === lembagaKey);

                // Analyze
                const results = [];
                let exactMatch = 0;
                let fuzzyMatch = 0;
                let notFound = 0;
                let zeroHafalan = 0;

                Object.entries(allGuruData).forEach(([guruName, guruStudents]) => {
                    Object.entries(guruStudents).forEach(([studentKey, studentData]) => {
                        const apiName = String(studentData.namaSiswa || studentData.nama || studentKey).trim();
                        const rawTotal = studentData.totalHafalan;
                        
                        let total = 0;
                        if (typeof rawTotal === 'number') {
                            total = rawTotal;
                        } else if (typeof rawTotal === 'string') {
                            total = parseFloat(rawTotal) || 0;
                        }

                        const targetNorm = normalizeName(apiName);
                        
                        // Try exact match
                        let match = students.find(s => normalizeName(s.name) === targetNorm);
                        let matchType = 'exact';
                        let similarity = 100;

                        // Try fuzzy match
                        if (!match) {
                            const fuzzyMatches = students.map(s => ({
                                student: s,
                                similarity: calculateSimilarity(targetNorm, normalizeName(s.name))
                            })).filter(m => m.similarity > 80);

                            if (fuzzyMatches.length > 0) {
                                fuzzyMatches.sort((a, b) => b.similarity - a.similarity);
                                match = fuzzyMatches[0].student;
                                matchType = 'fuzzy';
                                similarity = fuzzyMatches[0].similarity;
                            } else {
                                matchType = 'not-found';
                            }
                        }

                        if (matchType === 'exact') exactMatch++;
                        else if (matchType === 'fuzzy') fuzzyMatch++;
                        else notFound++;

                        if (total === 0) zeroHafalan++;

                        results.push({
                            guru: guruName,
                            apiName,
                            localName: match ? match.name : '-',
                            apiTotal: total,
                            localTotal: match ? (match.total_hafalan || 0) : 0,
                            matchType,
                            similarity: similarity.toFixed(1)
                        });
                    });
                });

                // Summary
                summary.innerHTML = `
                    <p><strong>Total di API:</strong> ${results.length} santri</p>
                    <p><strong>Total di Local:</strong> ${students.length} santri</p>
                    <p><strong>Exact Match:</strong> ${exactMatch} ‚úÖ</p>
                    <p><strong>Fuzzy Match:</strong> ${fuzzyMatch} ‚ö†Ô∏è</p>
                    <p><strong>Not Found:</strong> ${notFound} ‚ùå</p>
                    <p><strong>Total Hafalan = 0:</strong> ${zeroHafalan} üîç</p>
                `;

                // Details table
                let html = '<table>';
                html += '<tr><th>Guru</th><th>Nama di API</th><th>Nama di Local</th><th>Total API</th><th>Total Local</th><th>Match</th><th>Similarity</th></tr>';
                
                results.forEach(r => {
                    let rowClass = '';
                    if (r.matchType === 'exact') rowClass = 'match';
                    else if (r.matchType === 'fuzzy') rowClass = 'mismatch';
                    else rowClass = 'not-found';
                    
                    if (r.apiTotal === 0) rowClass = 'zero';

                    html += `<tr class="${rowClass}">`;
                    html += `<td>${r.guru}</td>`;
                    html += `<td>${r.apiName}</td>`;
                    html += `<td>${r.localName}</td>`;
                    html += `<td>${r.apiTotal}</td>`;
                    html += `<td>${r.localTotal}</td>`;
                    html += `<td>${r.matchType}</td>`;
                    html += `<td>${r.similarity}%</td>`;
                    html += '</tr>';
                });
                
                html += '</table>';
                details.innerHTML = html;

            } catch (error) {
                summary.innerHTML = `<span style="color: red;">‚ùå Error: ${error.message}</span>`;
            }
        }

        // Auto run on load
        window.addEventListener('load', () => {
            analyzeSync();
        });
    </script>
</body>
</html>
