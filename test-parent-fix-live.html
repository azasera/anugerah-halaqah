<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test & Fix Parent Login</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
        }
        button:hover { background: #45a049; }
        button.secondary { background: #2196F3; }
        button.secondary:hover { background: #0b7dda; }
        button.danger { background: #f44336; }
        button.danger:hover { background: #da190b; }
        pre {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .info { color: blue; }
        .warning { color: orange; font-weight: bold; }
        h2 { margin-top: 0; color: #333; }
        .status { padding: 10px; border-radius: 4px; margin: 10px 0; }
        .status.success { background: #d4edda; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <h1>üîß Test & Fix Parent Login</h1>
    
    <div class="card">
        <h2>Status Saat Ini</h2>
        <div id="currentStatus"></div>
        <button onclick="checkStatus()">üîÑ Refresh Status</button>
    </div>

    <div class="card">
        <h2>Quick Actions</h2>
        <button onclick="runDebug()">üîç Run Debug</button>
        <button class="secondary" onclick="manualFix()">üîß Manual Fix</button>
        <button class="secondary" onclick="refreshLink()">üîó Refresh Link</button>
        <button class="danger" onclick="clearOutput()">üóëÔ∏è Clear Output</button>
    </div>

    <div class="card">
        <h2>Output</h2>
        <div id="output"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const div = document.createElement('div');
            div.className = type;
            div.textContent = message;
            output.appendChild(div);
            console.log(message);
        }

        function clearOutput() {
            document.getElementById('output').innerHTML = '';
        }

        function checkStatus() {
            const statusDiv = document.getElementById('currentStatus');
            
            let html = '<div class="status info">';
            
            // Check if running in main app
            if (typeof window.currentUser === 'undefined') {
                html += '<p class="error">‚ùå Tidak terdeteksi di aplikasi utama</p>';
                html += '<p>Buka file ini di tab yang sama dengan aplikasi (index.html)</p>';
                html += '<p>Atau buka Console (F12) di aplikasi dan jalankan perintah manual</p>';
                statusDiv.innerHTML = html + '</div>';
                return;
            }
            
            html += '<p><strong>User:</strong> ' + (window.currentUser?.email || 'Not logged in') + '</p>';
            html += '<p><strong>Profile:</strong> ' + (window.currentProfile?.full_name || 'N/A') + ' (' + (window.currentProfile?.role || 'N/A') + ')</p>';
            html += '<p><strong>Current User Child:</strong> ' + (window.currentUserChild?.name || '‚ùå NULL') + '</p>';
            html += '<p><strong>Total Students:</strong> ' + (typeof dashboardData !== 'undefined' ? dashboardData.students.length : 'N/A') + '</p>';
            
            if (window.currentProfile?.role === 'ortu' && !window.currentUserChild) {
                html += '<p class="warning">‚ö†Ô∏è Orang tua login tapi child tidak ter-link!</p>';
            } else if (window.currentUserChild) {
                html += '<p class="success">‚úÖ Child ter-link dengan benar</p>';
            }
            
            html += '</div>';
            statusDiv.innerHTML = html;
        }

        function runDebug() {
            clearOutput();
            log('=== DEBUG PARENT LOGIN ===', 'info');
            
            if (typeof window.currentUser === 'undefined') {
                log('‚ùå Tidak terdeteksi di aplikasi utama', 'error');
                log('Buka Console (F12) di tab aplikasi dan jalankan:', 'info');
                log('', 'info');
                log('const script = document.createElement("script");', 'info');
                log('script.src = "test-parent-fix-live.html";', 'info');
                log('document.head.appendChild(script);', 'info');
                return;
            }
            
            log('', 'info');
            log('1Ô∏è‚É£ CURRENT USER:', 'info');
            log('Email: ' + (window.currentUser?.email || 'N/A'), 'info');
            log('Profile: ' + (window.currentProfile?.full_name || 'N/A'), 'info');
            log('Role: ' + (window.currentProfile?.role || 'N/A'), 'info');
            log('Current Child: ' + (window.currentUserChild?.name || 'NULL'), window.currentUserChild ? 'success' : 'error');
            
            log('', 'info');
            log('2Ô∏è‚É£ DATA STUDENTS:', 'info');
            log('Total: ' + dashboardData.students.length, 'info');
            
            if (window.currentUser && window.currentUser.email) {
                log('', 'info');
                log('3Ô∏è‚É£ NIK/NISN MATCH:', 'info');
                const nikOrNisn = window.currentUser.email.split('@')[0].trim();
                log('Looking for: ' + nikOrNisn, 'info');
                
                const matched = dashboardData.students.find(s =>
                    (s.nik && String(s.nik).trim() === nikOrNisn) ||
                    (s.nisn && String(s.nisn).trim() === nikOrNisn)
                );
                
                if (matched) {
                    log('‚úÖ FOUND: ' + matched.name + ' (ID: ' + matched.id + ')', 'success');
                } else {
                    log('‚ùå NOT FOUND', 'error');
                    log('Available NIKs: ' + dashboardData.students.map(s => s.nik).filter(Boolean).join(', '), 'info');
                }
            }
            
            log('', 'info');
            log('=== END DEBUG ===', 'info');
            
            checkStatus();
        }

        async function manualFix() {
            clearOutput();
            log('üîß Starting manual fix...', 'info');
            
            if (typeof window.currentUser === 'undefined') {
                log('‚ùå Tidak terdeteksi di aplikasi utama', 'error');
                return;
            }
            
            if (!window.currentUser || !window.currentProfile) {
                log('‚ùå Not logged in!', 'error');
                return;
            }
            
            if (window.currentProfile.role !== 'ortu') {
                log('‚ÑπÔ∏è Not a parent account (Role: ' + window.currentProfile.role + ')', 'info');
                return;
            }
            
            const nikOrNisn = window.currentUser.email.split('@')[0].trim();
            log('üîç Looking for student with NIK/NISN: ' + nikOrNisn, 'info');
            
            const matched = dashboardData.students.find(s =>
                (s.nik && String(s.nik).trim() === nikOrNisn) ||
                (s.nisn && String(s.nisn).trim() === nikOrNisn)
            );
            
            if (matched) {
                log('‚úÖ Found student: ' + matched.name, 'success');
                window.currentUserChild = matched;
                
                if (typeof renderSantri === 'function') {
                    renderSantri();
                    log('‚úÖ UI refreshed - data should now be visible', 'success');
                }
                
                if (typeof refreshAllData === 'function') {
                    refreshAllData();
                    log('‚úÖ All data refreshed', 'success');
                }
            } else {
                log('‚ùå No student found with NIK/NISN: ' + nikOrNisn, 'error');
                log('Available students:', 'info');
                dashboardData.students.slice(0, 10).forEach(s => {
                    log('  - ' + s.name + ' (NIK: ' + s.nik + ', NISN: ' + s.nisn + ')', 'info');
                });
            }
            
            checkStatus();
        }

        async function refreshLink() {
            clearOutput();
            log('üîó Refreshing parent-child link...', 'info');
            
            if (typeof window.refreshUserChildLink === 'function') {
                try {
                    await window.refreshUserChildLink();
                    log('‚úÖ Refresh completed', 'success');
                    
                    if (typeof renderSantri === 'function') {
                        renderSantri();
                        log('‚úÖ UI refreshed', 'success');
                    }
                } catch (error) {
                    log('‚ùå Error: ' + error.message, 'error');
                }
            } else {
                log('‚ùå refreshUserChildLink function not available', 'error');
            }
            
            checkStatus();
        }

        // Auto-check status on load
        setTimeout(checkStatus, 500);
    </script>
</body>
</html>
