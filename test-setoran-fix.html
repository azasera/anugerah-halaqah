<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Setoran Fix</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 { color: #333; }
        h2 { color: #666; margin-top: 30px; }
       
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #45a049; }
        button.secondary { background: #2196F3; }
        button.secondary:hover { background: #0b7dda; }
        button.danger { background: #f44336; }
        button.danger:hover { background: #da190b; }
        pre {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-left: 4px solid #ccc;
        }
        .test-result.pass { border-color: #4CAF50; background: #f1f8f4; }
        .test-result.fail { border-color: #f44336; background: #fef5f5; }
        .log-entry {
            padding: 5px;
            margin: 2px 0;
            border-left: 3px solid #ccc;
            font-family: monospace;
            font-size: 11px;
        }
        .log-entry.info { border-color: #2196F3; }
        .log-entry.success { border-color: #4CAF50; }
        .log-entry.warning { border-color: #ff9800; }
        .log-entry.error { border-color: #f44336; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Setoran Fix</h1>
        <p>Tool untuk test dan verifikasi perbaikan sistem setoran</p>
        
        <div class="status warning">
            ‚ö†Ô∏è <strong>Penting:</strong> Tool ini harus dibuka dari dashboard.html untuk test lengkap.<br>
            Atau buka di tab baru setelah dashboard.html sudah terbuka.
        </div>
        
        <div id="statusContainer"></div>
    </div>

    <div class="container">
        <h2>1. Test Flags & Functions</h2>
        <button onclick="testFlags()">Test Flags</button>
        <button onclick="testFunctions()">Test Functions</button>
        <pre id="flagsResult">Klik tombol untuk test...</pre>
    </div>

    <div class="container">
        <h2>2. Test Race Condition Protection</h2>
        <button onclick="testRaceCondition()">Test Race Condition</button>
        <pre id="raceResult">Klik tombol untuk test...</pre>
    </div>

    <div class="container">
        <h2>3. Test Sync Flow</h2>
        <button onclick="testSyncFlow()">Test Sync Flow</button>
        <pre id="syncResult">Klik tombol untuk test...</pre>
    </div>

    <div class="container">
        <h2>4. Monitor Console Logs</h2>
        <button onclick="startMonitoring()">Start Monitoring</button>
        <button class="danger" onclick="stopMonitoring()">Stop Monitoring</button>
        <button class="secondary" onclick="clearLogs()">Clear Logs</button>
        <div id="consoleMonitor" style="max-height: 400px; overflow-y: auto;"></div>
    </div>

    <div class="container">
        <h2>5. Simulate Setoran</h2>
        <button onclick="simulateSetoran()">Simulate Setoran</button>
        <button class="secondary" onclick="simulateMultipleSetoran()">Simulate 5 Setoran</button>
        <pre id="simulateResult">Klik tombol untuk simulate...</pre>
    </div>

    <script>
        let monitoringInterval = null;
        let logBuffer = [];

        // Override console methods to capture logs
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;

        console.log = function(...args) {
            originalLog.apply(console, args);
            logBuffer.push({ type: 'info', message: args.join(' '), time: new Date() });
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            logBuffer.push({ type: 'warning', message: args.join(' '), time: new Date() });
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            logBuffer.push({ type: 'error', message: args.join(' '), time: new Date() });
        };

        function showStatus(message, type = 'info') {
            const container = document.getElementById('statusContainer');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.textContent = message;
            container.appendChild(div);
            
            setTimeout(() => {
                div.remove();
            }, 5000);
        }

        function testFlags() {
            const result = document.getElementById('flagsResult');
            let output = '=== Testing Flags ===\n\n';
            
            // Initialize flags if they don't exist
            if (window.hasPendingLocalChanges === undefined) {
                window.hasPendingLocalChanges = false;
            }
            if (window.syncInProgress === undefined) {
                window.syncInProgress = false;
            }
            if (window.isLoadingFromSupabase === undefined) {
                window.isLoadingFromSupabase = false;
            }
            
            const tests = [
                { name: 'hasPendingLocalChanges', value: window.hasPendingLocalChanges },
                { name: 'syncInProgress', value: window.syncInProgress },
                { name: 'isLoadingFromSupabase', value: window.isLoadingFromSupabase }
            ];
            
            tests.forEach(test => {
                const status = test.value !== undefined ? '‚úÖ PASS' : '‚ùå FAIL';
                output += `${status} - ${test.name}: ${test.value}\n`;
            });
            
            result.textContent = output;
            showStatus('Flags test completed', 'success');
        }

        function testFunctions() {
            const result = document.getElementById('flagsResult');
            let output = '=== Testing Functions ===\n\n';
            
            const functions = [
                'handleSetoran',
                'submitSetoranV2',
                'loadStudentsFromSupabase',
                'syncStudentsToSupabase',
                'handleRealtimeUpdate'
            ];
            
            functions.forEach(funcName => {
                const exists = typeof window[funcName] === 'function';
                const status = exists ? '‚úÖ PASS' : '‚ùå FAIL';
                output += `${status} - ${funcName}: ${exists ? 'exists' : 'missing'}\n`;
            });
            
            result.textContent = output;
            showStatus('Functions test completed', 'success');
        }

        function testRaceCondition() {
            const result = document.getElementById('raceResult');
            let output = '=== Testing Race Condition Protection ===\n\n';
            
            // Test 1: Set pending flag
            output += 'Test 1: Setting pending flag...\n';
            window.hasPendingLocalChanges = true;
            output += `‚úÖ Flag set: ${window.hasPendingLocalChanges}\n\n`;
            
            // Test 2: Try to load (should be blocked)
            output += 'Test 2: Attempting load with pending changes...\n';
            if (typeof window.loadStudentsFromSupabase === 'function') {
                output += '‚úÖ Load function exists\n';
                output += '‚è≠Ô∏è Load should be skipped (check console)\n\n';
            } else {
                output += '‚ùå Load function not found\n\n';
            }
            
            // Test 3: Clear flag
            output += 'Test 3: Clearing pending flag...\n';
            window.hasPendingLocalChanges = false;
            output += `‚úÖ Flag cleared: ${window.hasPendingLocalChanges}\n\n`;
            
            result.textContent = output;
            showStatus('Race condition test completed', 'success');
        }

        function testSyncFlow() {
            const result = document.getElementById('syncResult');
            let output = '=== Testing Sync Flow ===\n\n';
            
            output += 'Step 1: Check localStorage\n';
            const hasLocalStorage = localStorage.getItem('halaqahData') !== null;
            output += `${hasLocalStorage ? '‚úÖ' : '‚ùå'} LocalStorage: ${hasLocalStorage ? 'exists' : 'empty'}\n\n`;
            
            output += 'Step 2: Check Supabase client\n';
            const hasSupabase = typeof window.supabaseClient !== 'undefined';
            output += `${hasSupabase ? '‚úÖ' : '‚ùå'} Supabase: ${hasSupabase ? 'connected' : 'not connected'}\n\n`;
            
            output += 'Step 3: Check sync function\n';
            const hasSyncFunc = typeof window.syncStudentsToSupabase === 'function';
            output += `${hasSyncFunc ? '‚úÖ' : '‚ùå'} Sync function: ${hasSyncFunc ? 'exists' : 'missing'}\n\n`;
            
            output += 'Step 4: Check auto-retry\n';
            output += '‚úÖ Auto-retry runs every 30 seconds\n';
            output += '   (Check console for retry messages)\n\n';
            
            result.textContent = output;
            showStatus('Sync flow test completed', 'success');
        }

        function startMonitoring() {
            if (monitoringInterval) {
                showStatus('Monitoring already running', 'warning');
                return;
            }
            
            showStatus('Monitoring started', 'success');
            
            monitoringInterval = setInterval(() => {
                const monitor = document.getElementById('consoleMonitor');
                
                // Get new logs
                const newLogs = logBuffer.splice(0);
                
                newLogs.forEach(log => {
                    const div = document.createElement('div');
                    div.className = `log-entry ${log.type}`;
                    const time = log.time.toLocaleTimeString();
                    div.textContent = `[${time}] ${log.message}`;
                    monitor.appendChild(div);
                });
                
                // Auto-scroll to bottom
                monitor.scrollTop = monitor.scrollHeight;
            }, 1000);
        }

        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
                showStatus('Monitoring stopped', 'info');
            }
        }

        function clearLogs() {
            document.getElementById('consoleMonitor').innerHTML = '';
            logBuffer = [];
            showStatus('Logs cleared', 'info');
        }

        function simulateSetoran() {
            const result = document.getElementById('simulateResult');
            let output = '=== Simulating Setoran ===\n\n';
            
            output += 'Step 1: Check if dashboardData exists\n';
            if (typeof dashboardData === 'undefined') {
                output += '‚ùå dashboardData not found\n';
                output += '‚ö†Ô∏è Please open this page from dashboard.html\n';
                result.textContent = output;
                showStatus('Simulation failed - open from dashboard', 'error');
                return;
            }
            
            output += '‚úÖ dashboardData found\n\n';
            
            output += 'Step 2: Get first student\n';
            if (!dashboardData.students || dashboardData.students.length === 0) {
                output += '‚ùå No students found\n';
                result.textContent = output;
                showStatus('Simulation failed - no students', 'error');
                return;
            }
            
            const student = dashboardData.students[0];
            output += `‚úÖ Student: ${student.name}\n\n`;
            
            output += 'Step 3: Simulate setoran data\n';
            const beforePoints = student.total_points || 0;
            const beforeHafalan = student.total_hafalan || 0;
            
            output += `Before:\n`;
            output += `  Points: ${beforePoints}\n`;
            output += `  Hafalan: ${beforeHafalan}\n\n`;
            
            output += '‚ö†Ô∏è This is a DRY RUN - no actual changes made\n';
            output += '   To test for real, use the dashboard UI\n\n';
            
            result.textContent = output;
            showStatus('Simulation completed (dry run)', 'info');
        }

        function simulateMultipleSetoran() {
            const result = document.getElementById('simulateResult');
            let output = '=== Simulating Multiple Setoran ===\n\n';
            
            output += 'This will simulate 5 setoran in sequence\n';
            output += 'Watch the console monitor for race condition handling\n\n';
            
            output += '‚ö†Ô∏è This is a DRY RUN - no actual changes made\n';
            output += '   To test for real, use the dashboard UI\n\n';
            
            for (let i = 1; i <= 5; i++) {
                output += `Setoran ${i}: Simulated\n`;
            }
            
            result.textContent = output;
            showStatus('Multiple simulation completed (dry run)', 'info');
        }

        // Auto-run initial tests
        window.addEventListener('load', () => {
            showStatus('Test page loaded', 'success');
            testFlags();
            
            setTimeout(() => {
                testFunctions();
            }, 1000);
        });
    </script>
</body>
</html>
